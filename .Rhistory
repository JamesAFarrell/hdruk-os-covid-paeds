) %>%
unnest(date_period)
}) %>%
bind_rows()
monthly_beddays = monthly_patient %>%
left_join(
bedday_counts,
by = c("patient_id", "date_period")
)
## Bed-days ----
### Create bed-days dataset ----
bedday_counts = data_admissions %>%
rowwise() %>%
mutate(dates = list(seq(admission_date, discharge_date, by = "day"))) %>%
unnest(dates) %>%
mutate(date_period = floor_date(dates, unit = "month")) %>%
group_by(patient_id, index) %>%
mutate(
daily_count = case_when(
(admission_date == discharge_date) ~ 0.5, # Day-case
row_number() == 1 ~ 0,
TRUE ~ 1
)
) %>%
group_by(patient_id, date_period) %>%
summarise(
bed_days = sum(daily_count)
) %>%
ungroup()
View(bedday_counts)
## Bed-days ----
### Create bed-days dataset ----
counts_bedday = data_admissions %>%
rowwise() %>%
mutate(dates = list(seq(admission_date, discharge_date, by = "day"))) %>%
unnest(dates) %>%
mutate(date_period = floor_date(dates, unit = "month")) %>%
group_by(patient_id, index) %>%
mutate(
daily_count = case_when(
(admission_date == discharge_date) ~ 0.5, # Day-case
row_number() == 1 ~ 0,
TRUE ~ 1
)
) %>%
group_by(patient_id, date_period) %>%
summarise(
bed_days = sum(daily_count)
) %>%
ungroup()
monthly_beddays = monthly_patient %>%
left_join(
counts_bedday,
by = c("patient_id", "date_period")
)
View(monthly_beddays)
View(counts_bedday)
monthly_beddays = monthly_patient %>%
left_join(
counts_bedday,
by = c("patient_id", "date_period")
) %>%
replace_na(list(bed_days = 0))
View(monthly_beddays)
## Bed-days ----
### Create bed-days dataset ----
counts_bedday = data_admissions %>%
rowwise() %>%
mutate(dates = list(seq(admission_date, discharge_date, by = "day"))) %>%
unnest(dates) %>%
mutate(date_period = floor_date(dates, unit = "month")) %>%
group_by(patient_id, index) %>%
mutate(
daily_count = case_when(
(admission_date == discharge_date) ~ 0.5, # Day-case
row_number() == 1 ~ 0,
TRUE ~ 1
)
) %>%
group_by(patient_id, date_period) %>%
summarise(
bed_days = sum(daily_count)
) %>%
ungroup() %>%
mutate(cohort = year(date_period))
View(counts_bedday)
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
.data_cohort %>%
summarise(n_patient = n())
})
monthly_beddays
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "overall"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var))
) %>%
group_by(cohort, group) %>%
summarise(beddays = sum(bed_days))
# denominator = .data_cohort %>%
#   summarise(
#     cohort = cohort,
#     n_patient = n())
})
monthly_beddays[[1]]
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "overall"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var))
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = group_var,
beddays = sum(bed_days)
)
# denominator = .data_cohort %>%
#   summarise(
#     cohort = cohort,
#     n_patient = n())
})
monthly_beddays
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "overall"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var))
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = group_var,
beddays = sum(bed_days)
)
# denominator = .data_cohort %>%
#   summarise(
#     cohort = cohort,
#     n_patient = n())
})
monthly_beddays[[1]]
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "overall"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var))
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
group_by(cohort, group = all_of(group_var)) %>%
summarise(
cohort = cohort,
n_patient = n())
denominator
})
monthly_beddays
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "overall"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var))
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(group_var))
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
denominator
})
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "overall"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var))
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
denominator
})
monthly_beddays
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "overall"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var))
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
numerator %>%
left_join(denominator,
by = c("cohort", "group"))
})
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "overall"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var)),
by = c("patient_id")
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
numerator %>%
left_join(denominator,
by = c("cohort", "group"))
})
monthly_beddays
monthly_beddays = data_cohort %>%
map2(index_date, function(.data_cohort, .index_date){
group_var = "age_group"
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(group_var)),
by = c("patient_id")
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
numerator %>%
left_join(denominator,
by = c("cohort", "group"))
}) %>%
bind_rows()
View(monthly_beddays)
monthly_beddays = group_var %>%
map(function(.group_var){
data_cohort %>%
map2(index_date, function(.data_cohort, .index_date, .group_var){
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(.group_var)),
by = c("patient_id")
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = .group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(.group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
numerator %>%
left_join(denominator,
by = c("cohort", "group"))
},
.group_var = .group_var)
}) %>%
bind_rows()
monthly_beddays = group_variable_list %>%
map(function(.group_var){
data_cohort %>%
map2(index_date, function(.data_cohort, .index_date, .group_var){
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(.group_var)),
by = c("patient_id")
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = .group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(.group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
numerator %>%
left_join(denominator,
by = c("cohort", "group"))
},
.group_var = .group_var)
}) %>%
bind_rows()
group_variable_list = c("overall", "age_group")
monthly_beddays = group_variable_list %>%
map(function(.group_var){
data_cohort %>%
map2(index_date, function(.data_cohort, .index_date, .group_var){
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(.group_var)),
by = c("patient_id")
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = .group_var,
beddays = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(.group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
numerator %>%
left_join(denominator,
by = c("cohort", "group"))
},
.group_var = .group_var)
}) %>%
bind_rows()
View(monthly_beddays)
View(tbl_cohort_summary)
View(tbl_cohort_summary)
### Create monthly table ----
tbl_monthly_beddays = group_variable_list %>%
map(function(.group_var){
data_cohort %>%
map2(index_date, function(.data_cohort, .index_date, .group_var){
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_bedday %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(.group_var)),
by = c("patient_id")
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = .group_var,
bed_days = sum(bed_days)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(.group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
numerator %>%
left_join(denominator,
by = c("cohort", "group"))
},
.group_var = .group_var)
}) %>%
bind_rows() %>%
relocate(cohort, date_period, group_var, group) %>%
mutate(mean_beddays = bed_days/n_patient)
View(tbl_monthly_beddays)
## Admissions ----
### Count admissions by month ----
counts_admissions = data_admissions %>%
mutate(date_period = floor_date(admission_date, unit = "month")) %>%
group_by(patient_id, date_period) %>%
count(date_period) %>%
mutate(cohort = year(date_period))
View(counts_admissions)
### Create monthly bed-days table ----
tbl_monthly_admissions = group_variable_list %>%
map(function(.group_var){
data_cohort %>%
map2(index_date, function(.data_cohort, .index_date, .group_var){
.data_cohort = .data_cohort %>%
mutate(overall = "Overall")
numerator = counts_admissions %>%
filter(cohort == year(.index_date),
date_period %in% time_seq,
patient_id %in% .data_cohort$patient_id) %>%
left_join(
.data_cohort %>%
select(patient_id, group = all_of(.group_var)),
by = c("patient_id")
) %>%
group_by(cohort, date_period, group) %>%
summarise(
group_var = .group_var,
admissions = sum(n)
)
denominator = .data_cohort %>%
select(patient_id, cohort, group = all_of(.group_var)) %>%
group_by(cohort, group) %>%
summarise(
n_patient = n()
)
numerator %>%
left_join(denominator,
by = c("cohort", "group"))
},
.group_var = .group_var)
}) %>%
bind_rows() %>%
relocate(cohort, date_period, group_var, group) %>%
mutate(mean_admissions = admissions/n_patient)
View(tbl_monthly_admissions)
