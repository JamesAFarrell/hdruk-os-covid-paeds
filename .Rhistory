"XII: Diseases of the skin and subcutaneous tissue",
"XIII: Diseases of the musculoskeletal system and connective tissue",
"XIV: Diseases of the genitourinary system",
"XV: Pregnancy, childbirth and the puerperium",
"XVI: Certain conditions originating in the perinatal period",
"XVII: Congenital malformations, deformations and chromosomal abnormalities",
"XVIII: Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified",
"XIX: Injury, poisoning and certain other consequences of external causes",
"XX: External causes of morbidity and mortality",
"XXI: Factors influencing health status and contact with health services",
"XXII: Codes for special purposes",
),
chapter_number = chapter_long %>%
str_remove(":.*") %>%
factor() %>%
fct_relevel(as.roman(1:22))
)
as.roman(1:22) %>% class()
as.roman(1:22) %>% as.character()
lookup_icd10 = lookup_icd10 %>%
mutate(
chapter_long = case_when(
str_sub(code, 1,1) == "A" ~ "I: Certain infectious and parasitic diseases",
str_sub(code, 1,1) == "B" ~ "I: Certain infectious and parasitic diseases",
str_sub(code, 1,1) == "C" ~ "II: Neoplasms",
str_sub(code, 1,3) %in% sprintf("%s%02d", "D",  0:49) ~ "II: Neoplasms",
str_sub(code, 1,3) %in% sprintf("%s%02d", "D",  50:89) ~ "III: Diseases of the blood and blood-forming organs and certain disorders involving the immune mechanism",
str_sub(code, 1,1) == "E" ~ "IV: Endocrine, nutritional and metabolic diseases",
str_sub(code, 1,1) == "F" ~ "V: Mental and behavioural disorders",
str_sub(code, 1,1) == "G" ~ "VI: Diseases of the nervous system",
str_sub(code, 1,3) %in% sprintf("%s%02d", "H",  0:59) ~ "VII: Diseases of the eye and adnexa",
str_sub(code, 1,3) %in% sprintf("%s%02d", "H",  60:95) ~ "VIII: Diseases of the ear and mastoid process",
str_sub(code, 1,1) == "I" ~ "IX: Diseases of the circulatory system",
str_sub(code, 1,1) == "J" ~ "X: Diseases of the respiratory system",
str_sub(code, 1,1) == "K" ~ "XI: Diseases of the digestive system",
str_sub(code, 1,1) == "L" ~ "XII: Diseases of the skin and subcutaneous tissue",
str_sub(code, 1,1) == "M" ~ "XIII: Diseases of the musculoskeletal system and connective tissue",
str_sub(code, 1,1) == "N" ~ "XIV: Diseases of the genitourinary system",
str_sub(code, 1,1) == "O" ~ "XV: Pregnancy, childbirth and the puerperium",
str_sub(code, 1,1) == "P" ~ "XVI: Certain conditions originating in the perinatal period",
str_sub(code, 1,1) == "Q" ~ "XVII: Congenital malformations, deformations and chromosomal abnormalities",
str_sub(code, 1,1) == "R" ~ "XVIII: Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified",
str_sub(code, 1,1) == "S" ~ "XIX: Injury, poisoning and certain other consequences of external causes",
str_sub(code, 1,1) == "T" ~ "XIX: Injury, poisoning and certain other consequences of external causes",
str_sub(code, 1,1) == "V" ~ "XX: External causes of morbidity and mortality",
str_sub(code, 1,1) == "X" ~ "XX: External causes of morbidity and mortality",
str_sub(code, 1,1) == "Y" ~ "XX: External causes of morbidity and mortality",
str_sub(code, 1,1) == "Y" ~ "XX: External causes of morbidity and mortality",
str_sub(code, 1,1) == "Z" ~ "XXI: Factors influencing health status and contact with health services",
str_sub(code, 1,1) == "U" ~ "XXII: Codes for special purposes",
) %>%
factor() %>%
fct_relevel(
"I: Certain infectious and parasitic diseases",
"II: Neoplasms",
"III: Diseases of the blood and blood-forming organs and certain disorders involving the immune mechanism",
"IV: Endocrine, nutritional and metabolic diseases",
"V: Mental and behavioural disorders",
"VI: Diseases of the nervous system",
"VII: Diseases of the eye and adnexa",
"VIII: Diseases of the ear and mastoid process",
"IX: Diseases of the circulatory system",
"X: Diseases of the respiratory system",
"XI: Diseases of the digestive system",
"XII: Diseases of the skin and subcutaneous tissue",
"XIII: Diseases of the musculoskeletal system and connective tissue",
"XIV: Diseases of the genitourinary system",
"XV: Pregnancy, childbirth and the puerperium",
"XVI: Certain conditions originating in the perinatal period",
"XVII: Congenital malformations, deformations and chromosomal abnormalities",
"XVIII: Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified",
"XIX: Injury, poisoning and certain other consequences of external causes",
"XX: External causes of morbidity and mortality",
"XXI: Factors influencing health status and contact with health services",
"XXII: Codes for special purposes",
),
chapter_number = chapter_long %>%
str_remove(":.*") %>%
factor() %>%
fct_relevel(as.character(as.roman(1:22)))
)
lookup_icd10 %>% summary()
lookup_icd10 = lookup_icd10 %>%
mutate(
chapter_long = case_when(
str_sub(code, 1,1) == "A" ~ "I: Certain infectious and parasitic diseases",
str_sub(code, 1,1) == "B" ~ "I: Certain infectious and parasitic diseases",
str_sub(code, 1,1) == "C" ~ "II: Neoplasms",
str_sub(code, 1,3) %in% sprintf("%s%02d", "D",  0:49) ~ "II: Neoplasms",
str_sub(code, 1,3) %in% sprintf("%s%02d", "D",  50:89) ~ "III: Diseases of the blood and blood-forming organs and certain disorders involving the immune mechanism",
str_sub(code, 1,1) == "E" ~ "IV: Endocrine, nutritional and metabolic diseases",
str_sub(code, 1,1) == "F" ~ "V: Mental and behavioural disorders",
str_sub(code, 1,1) == "G" ~ "VI: Diseases of the nervous system",
str_sub(code, 1,3) %in% sprintf("%s%02d", "H",  0:59) ~ "VII: Diseases of the eye and adnexa",
str_sub(code, 1,3) %in% sprintf("%s%02d", "H",  60:95) ~ "VIII: Diseases of the ear and mastoid process",
str_sub(code, 1,1) == "I" ~ "IX: Diseases of the circulatory system",
str_sub(code, 1,1) == "J" ~ "X: Diseases of the respiratory system",
str_sub(code, 1,1) == "K" ~ "XI: Diseases of the digestive system",
str_sub(code, 1,1) == "L" ~ "XII: Diseases of the skin and subcutaneous tissue",
str_sub(code, 1,1) == "M" ~ "XIII: Diseases of the musculoskeletal system and connective tissue",
str_sub(code, 1,1) == "N" ~ "XIV: Diseases of the genitourinary system",
str_sub(code, 1,1) == "O" ~ "XV: Pregnancy, childbirth and the puerperium",
str_sub(code, 1,1) == "P" ~ "XVI: Certain conditions originating in the perinatal period",
str_sub(code, 1,1) == "Q" ~ "XVII: Congenital malformations, deformations and chromosomal abnormalities",
str_sub(code, 1,1) == "R" ~ "XVIII: Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified",
str_sub(code, 1,1) == "S" ~ "XIX: Injury, poisoning and certain other consequences of external causes",
str_sub(code, 1,1) == "T" ~ "XIX: Injury, poisoning and certain other consequences of external causes",
str_sub(code, 1,1) == "V" ~ "XX: External causes of morbidity and mortality",
str_sub(code, 1,1) == "W" ~ "XX: External causes of morbidity and mortality",
str_sub(code, 1,1) == "X" ~ "XX: External causes of morbidity and mortality",
str_sub(code, 1,1) == "Y" ~ "XX: External causes of morbidity and mortality",
str_sub(code, 1,1) == "Z" ~ "XXI: Factors influencing health status and contact with health services",
str_sub(code, 1,1) == "U" ~ "XXII: Codes for special purposes",
) %>%
factor() %>%
fct_relevel(
"I: Certain infectious and parasitic diseases",
"II: Neoplasms",
"III: Diseases of the blood and blood-forming organs and certain disorders involving the immune mechanism",
"IV: Endocrine, nutritional and metabolic diseases",
"V: Mental and behavioural disorders",
"VI: Diseases of the nervous system",
"VII: Diseases of the eye and adnexa",
"VIII: Diseases of the ear and mastoid process",
"IX: Diseases of the circulatory system",
"X: Diseases of the respiratory system",
"XI: Diseases of the digestive system",
"XII: Diseases of the skin and subcutaneous tissue",
"XIII: Diseases of the musculoskeletal system and connective tissue",
"XIV: Diseases of the genitourinary system",
"XV: Pregnancy, childbirth and the puerperium",
"XVI: Certain conditions originating in the perinatal period",
"XVII: Congenital malformations, deformations and chromosomal abnormalities",
"XVIII: Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified",
"XIX: Injury, poisoning and certain other consequences of external causes",
"XX: External causes of morbidity and mortality",
"XXI: Factors influencing health status and contact with health services",
"XXII: Codes for special purposes",
),
chapter_number = chapter_long %>%
str_remove(":.*") %>%
factor() %>%
fct_relevel(as.character(as.roman(1:22)))
)
lookup_icd10 %>% summary()
source(here::here("analysis", "00_lookup_tables.R"))
# Load packages ----
library(tidyverse)
library(lubridate)
library(finalfit)
# Load custom functions ----
source(here::here("analysis", "00_utility_functions.R"))
source(here::here("analysis", "00_lookup_tables.R"))
# Create directory for outputs ----
dir.create(here::here("output", "data"), showWarnings = FALSE, recursive=TRUE)
dir.create(here::here("output", "diagnostics"), showWarnings = FALSE, recursive=TRUE)
dir.create(here::here("output", "descriptives", "data_admissions"), showWarnings = FALSE, recursive=TRUE)
# Load patient IDs
data_id = read_rds(here::here("output", "data", "data_id.rds"))
# Data Files ----
files_admissions = list.files(path = here::here("output", "data_weekly"),
pattern = "input_admissions_20\\d{2}-\\d{2}-\\d{2}.csv.gz")
# Admission data ----
data_admissions = here::here("output", "data_weekly", files_admissions) %>%
map(function(file){
file %>%
read_csv(col_types = read_column_type(.)) %>%
as_tibble()
})
# Extract diagnostics data  ----
diagnostics_admissions = data_admissions %>%
map(function(data){
n_row = nrow(data)
n_row_bad_id = data %>%
filter(!patient_id %in% data_id$patient_id) %>%
nrow()
n_col = ncol(data)
n_col_empty = data %>%
select_if(~(all(is.na(.)))) %>%
ncol()
n_empty_admission_1 = data %>%
select(admission_date_1) %>%
pull() %>% is.na() %>% sum()
n_empty_discharge_1 = data %>%
select(discharge_date_1) %>%
pull() %>% is.na() %>% sum()
n_empty_method_1 = data %>%
select(admission_method_1) %>%
pull() %>% is.na() %>% sum()
n_empty_primary_diagnosis_1 = data %>%
select(admission_method_1) %>%
pull() %>% is.na() %>% sum()
n_empty_treatment_function_1 = data %>%
select(admission_method_1) %>%
pull() %>% is.na() %>% sum()
max_count = data %>%
select(ends_with("_count")) %>%
pull() %>% max()
tibble(n_row, n_row_bad_id, n_col, n_col_empty,
n_empty_admission_1, n_empty_discharge_1, n_empty_method_1,
n_empty_primary_diagnosis_1, n_empty_treatment_function_1, max_count)
}) %>%
bind_rows() %>%
mutate(file = files_admissions) %>%
relocate(file)
# Filter out bad patient IDs, pivot longer ----
data_admissions = data_admissions %>%
map(function(data){
data %>%
filter(patient_id %in% data_id$patient_id) %>%
select(-ends_with("_count")) %>%
mutate_at(vars(starts_with(c("admission_date", "discharge_date"))),
as.character) %>%
pivot_longer(
cols = -patient_id,
names_to = c("variable", "index"),
names_pattern = "^(.*)_(\\d+)",
values_to = "data",
values_drop_na = TRUE
) %>%
pivot_wider(
names_from = variable,
values_from = data
)
})
## Filter out rows with missing or bad dates ----
data_admissions = data_admissions %>%
bind_rows() %>%
mutate_at(vars(contains("_date")), as.Date, format = "%Y-%m-%d") %>%
filter(admission_date <= discharge_date,
!is.na(admission_date),
!is.na(discharge_date)) %>%
arrange(patient_id, admission_date)
## Fix overlapping admission spells ----
data_admissions = data_admissions %>%
group_by(patient_id) %>%
mutate(index = row_number(),
overlap_with_prior =
case_when(admission_date < lag(discharge_date)~ 1,
TRUE ~ 0)) %>%
mutate(index = row_number() - cumsum(overlap_with_prior))%>%
select(-overlap_with_prior) %>%
group_by(patient_id, index) %>%
mutate(admission_date = min(admission_date),
discharge_date = max(discharge_date)) %>%
ungroup() %>%
distinct(patient_id, admission_date, discharge_date,
.keep_all = TRUE) %>%
group_by(patient_id) %>%
mutate(index = row_number()) %>%
ungroup()
#
data_admissions = data_admissions %>%
mutate(
admission_method.factor = admission_method %>%
fct_collapse(
Elective = c("11", "12", "13"),
Emergency = c("21", "22", "23", "24", "25", "2A", "2B", "2C", "2D", "28"),
other_level = "Other"
)
)
data_admissions = data_admissions %>%
left_join(
lookup_icd10 %>%
select(
primary_diagnosis = code,
primary_diagnosis.chapter = chapter_long,
primary_diagnosis.chapter_short = chapter_short
)
)
# Save data as rds ----
write_rds(data_admissions,
here::here("output", "data", "data_admissions.rds"),
compress="gz")
# Save diagnostics as csv ----
write_csv(diagnostics_admissions,
here::here("output", "diagnostics", "diagnostics_admissions.csv"))
# Save diagnostics as csv ----
write_csv(diagnostics_admissions,
here::here("output", "diagnostics", "overlap_admissions.csv"))
# Create plots ----
c("admission_date", "discharge_date") %>%
map(function(var){
# Plot weekly ----
plot_weekly = data_admissions %>%
count_dates_by_period(var, period = "week") %>%
ggplot(aes(x = date, y = n)) +
geom_line() +
theme_bw()
ggsave(filename = paste0("weekly_", var, ".jpeg"),
plot = plot_weekly,
path = here::here("output", "descriptives", "data_admissions"))
# Plot monthly ----
plot_monthly = data_admissions %>%
count_dates_by_period(var, period = "month") %>%
ggplot(aes(x = date, y = n)) +
geom_line() +
theme_bw()
ggsave(filename = paste0("monthly_", var, ".jpeg"),
plot = plot_monthly,
path = here::here("output", "descriptives", "data_admissions"))
})
View(lookup_icd10)
# Load packages ----
library(tidyverse)
library(lubridate)
library(finalfit)
# Load custom functions ----
source(here::here("analysis", "00_utility_functions.R"))
source(here::here("analysis", "00_lookup_tables.R"))
# Create directory for outputs ----
dir.create(here::here("output", "data"), showWarnings = FALSE, recursive=TRUE)
dir.create(here::here("output", "diagnostics"), showWarnings = FALSE, recursive=TRUE)
dir.create(here::here("output", "descriptives", "data_admissions"), showWarnings = FALSE, recursive=TRUE)
# Load patient IDs
data_id = read_rds(here::here("output", "data", "data_id.rds"))
# Data Files ----
files_admissions = list.files(path = here::here("output", "data_weekly"),
pattern = "input_admissions_20\\d{2}-\\d{2}-\\d{2}.csv.gz")
# Admission data ----
data_admissions = here::here("output", "data_weekly", files_admissions) %>%
map(function(file){
file %>%
read_csv(col_types = read_column_type(.)) %>%
as_tibble()
})
# Extract diagnostics data  ----
diagnostics_admissions = data_admissions %>%
map(function(data){
n_row = nrow(data)
n_row_bad_id = data %>%
filter(!patient_id %in% data_id$patient_id) %>%
nrow()
n_col = ncol(data)
n_col_empty = data %>%
select_if(~(all(is.na(.)))) %>%
ncol()
n_empty_admission_1 = data %>%
select(admission_date_1) %>%
pull() %>% is.na() %>% sum()
n_empty_discharge_1 = data %>%
select(discharge_date_1) %>%
pull() %>% is.na() %>% sum()
n_empty_method_1 = data %>%
select(admission_method_1) %>%
pull() %>% is.na() %>% sum()
n_empty_primary_diagnosis_1 = data %>%
select(admission_method_1) %>%
pull() %>% is.na() %>% sum()
n_empty_treatment_function_1 = data %>%
select(admission_method_1) %>%
pull() %>% is.na() %>% sum()
max_count = data %>%
select(ends_with("_count")) %>%
pull() %>% max()
tibble(n_row, n_row_bad_id, n_col, n_col_empty,
n_empty_admission_1, n_empty_discharge_1, n_empty_method_1,
n_empty_primary_diagnosis_1, n_empty_treatment_function_1, max_count)
}) %>%
bind_rows() %>%
mutate(file = files_admissions) %>%
relocate(file)
# Filter out bad patient IDs, pivot longer ----
data_admissions = data_admissions %>%
map(function(data){
data %>%
filter(patient_id %in% data_id$patient_id) %>%
select(-ends_with("_count")) %>%
mutate_at(vars(starts_with(c("admission_date", "discharge_date"))),
as.character) %>%
pivot_longer(
cols = -patient_id,
names_to = c("variable", "index"),
names_pattern = "^(.*)_(\\d+)",
values_to = "data",
values_drop_na = TRUE
) %>%
pivot_wider(
names_from = variable,
values_from = data
)
})
## Filter out rows with missing or bad dates ----
data_admissions = data_admissions %>%
bind_rows() %>%
mutate_at(vars(contains("_date")), as.Date, format = "%Y-%m-%d") %>%
filter(admission_date <= discharge_date,
!is.na(admission_date),
!is.na(discharge_date)) %>%
arrange(patient_id, admission_date)
## Fix overlapping admission spells ----
data_admissions = data_admissions %>%
group_by(patient_id) %>%
mutate(index = row_number(),
overlap_with_prior =
case_when(admission_date < lag(discharge_date)~ 1,
TRUE ~ 0)) %>%
mutate(index = row_number() - cumsum(overlap_with_prior))%>%
select(-overlap_with_prior) %>%
group_by(patient_id, index) %>%
mutate(admission_date = min(admission_date),
discharge_date = max(discharge_date)) %>%
ungroup() %>%
distinct(patient_id, admission_date, discharge_date,
.keep_all = TRUE) %>%
group_by(patient_id) %>%
mutate(index = row_number()) %>%
ungroup()
#
data_admissions = data_admissions %>%
mutate(
admission_method.factor = admission_method %>%
fct_collapse(
Elective = c("11", "12", "13"),
Emergency = c("21", "22", "23", "24", "25", "2A", "2B", "2C", "2D", "28"),
other_level = "Other"
)
)
data_admissions = data_admissions %>%
left_join(
lookup_icd10 %>%
select(
primary_diagnosis = code,
primary_diagnosis.chapter = chapter_long,
primary_diagnosis.chapter_num = chapter_number
),
by = "primary_diagnosis"
)
# Save data as rds ----
write_rds(data_admissions,
here::here("output", "data", "data_admissions.rds"),
compress="gz")
# Save diagnostics as csv ----
write_csv(diagnostics_admissions,
here::here("output", "diagnostics", "diagnostics_admissions.csv"))
# Save diagnostics as csv ----
write_csv(diagnostics_admissions,
here::here("output", "diagnostics", "overlap_admissions.csv"))
# Create plots ----
c("admission_date", "discharge_date") %>%
map(function(var){
# Plot weekly ----
plot_weekly = data_admissions %>%
count_dates_by_period(var, period = "week") %>%
ggplot(aes(x = date, y = n)) +
geom_line() +
theme_bw()
ggsave(filename = paste0("weekly_", var, ".jpeg"),
plot = plot_weekly,
path = here::here("output", "descriptives", "data_admissions"))
# Plot monthly ----
plot_monthly = data_admissions %>%
count_dates_by_period(var, period = "month") %>%
ggplot(aes(x = date, y = n)) +
geom_line() +
theme_bw()
ggsave(filename = paste0("monthly_", var, ".jpeg"),
plot = plot_monthly,
path = here::here("output", "descriptives", "data_admissions"))
})
knitr::opts_chunk$set(echo = TRUE)
# Load packages ----
library(tidyverse)
library(lubridate)
library(finalfit)
library(scales)
library(knitr)
# Load custom functions ----
source(here::here("analysis", "00_utility_functions.R"))
# Load datasets
data_admissions = read_rds(here::here("output", "data", "data_admissions.rds"))
data_outpatient = read_rds(here::here("output", "data", "data_outpatient.rds"))
data_gp = read_rds(here::here("output", "data", "data_gp.rds"))
theme_set(theme_bw())
plot_hist_date = function(.data, var, by = "week", breaks_by = "month",
week_start = 1,
fill = NULL){
.data %>%
ggplot(aes_string(x = var, fill = fill)) +
geom_histogram(breaks = date_seq(.data %>% pull(var), by = by)) +
scale_x_date(labels = scales::date_format("%b\n%Y"),
breaks = date_seq(.data %>% pull(var), by = breaks_by)) +
theme(axis.text.x = element_text(angle=0, vjust = 0.5, hjust = 0.5))
}
plot_hist_date(data_admissions, "admission_date",
by = "week", breaks_by = "3 months") +
labs(x = NULL, y = "Weekly count")
plot_hist_date(data_admissions, "admission_date",
by = "week", breaks_by = "3 months") +
labs(x = NULL, y = "Weekly count") +
facet_wrap(~ admission_method.factor, ncol = 1)
plot_hist_date(data_admissions, "admission_date",
by = "week", breaks_by = "3 months") +
labs(x = NULL, y = "Weekly count") +
facet_wrap(~ primary_diagnosis.factor, ncol = 1)
plot_hist_date(data_admissions, "admission_date",
by = "week", breaks_by = "3 months") +
labs(x = NULL, y = "Weekly count") +
facet_wrap(~ admission_method.factor, ncol = 1)
data_admissions %>%
mutate(
primary_diagnosis_chapter = str_sub(primary_diagnosis, end = 1)
) %>%
count(primary_diagnosis_chapter) %>%
mutate(perc = (n/sum(n)) %>% percent(accuracy = 0.1)) %>%
kable()
data_admissions %>%
count(treatment_function) %>%
mutate(perc = (n/sum(n)) %>% percent(accuracy = 0.1)) %>%
kable()
install.packages("icd")
install.packages("icd")
