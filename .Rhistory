select(patient_id, cohort_year, all_of(var))
) %>%
group_by(patient_id, cohort_year, .data[[var]]) %>%
summarise(period_index = 1:52) %>%
ungroup() %>%
left_join(
data_outpatient %>%
mutate(period_index = week(outpatient_date),
cohort_year = year(outpatient_date) %>% as.character()) %>%
group_by(patient_id, cohort_year, period_index) %>%
count(),
by = c("patient_id", "cohort_year", "period_index")
) %>%
mutate(n = replace_na(n, 0)) %>%
group_by(cohort_year, period_index, .data[[var]]) %>%
summarise(mean_n = mean(n),
mean_ci = boot_ci(n, statistic = meanfun, R = 1000),
n_patients = n()) %>%
ungroup() %>%
mutate(var_name = rep(c("ci_lower", "ci_upper"), times = n()/2)) %>%
pivot_wider(names_from = "var_name", values_from = "mean_ci")
outpatient_mean = outpatient_mean %>%
mutate(date = paste(cohort_year, "-01-01") %>% as.Date() +
(period_index -1)*7 +3)
paste("2019", "-01-01")
outpatient_mean = outpatient_mean %>%
mutate(date = paste0(cohort_year, "-01-01") %>% as.Date() +
(period_index -1)*7 +3)
View(outpatient_mean)
outpatient_mean %>%
ggplot(aes(date, mean_n)) +
geom_line() +
geom_point()
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year)) +
geom_line() +
geom_point()
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2,)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, "sex" )) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2,)
outpatient_mean %>%
ggplot(aes_string(date, mean_n, group = cohort_year, colour = var )) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2,)
outpatient_mean %>%
ggplot(aes_string("date", "mean_n", group = "cohort_year", colour = var )) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes_string("date", "mean_n", group = "cohort_year", colour = var )) +
geom_line()
outpatient_mean$cohort_year %>% class()
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex)) +
geom_line()
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, colour = sex), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year, colour = sex), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year, colour = NULL), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year, colour = sex), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = NULL, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year, colour = sex), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = NULL, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year, colour = NULL), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year, colour = NULL), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, group = cohort_year, colour = NULL, fill = sex), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = factor(cohort_year), colour = factor(sex))) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n,  colour = factor(sex))) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n,  colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = cohort_year, colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, group = factor(cohort_year), colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = sex, fill = sex), group = cohort_year) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = sex, fill = sex), group = cohort_year) +
geom_line()
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = sex, fill = sex, group = cohort_year)) +
geom_line()
var = NULL
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
bind_rows(
data_patient_2021 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
group_by(patient_id, cohort_year, .data[[var]]) %>%
summarise(period_index = 1:52) %>%
ungroup() %>%
left_join(
data_outpatient %>%
mutate(period_index = week(outpatient_date),
cohort_year = year(outpatient_date) %>% as.character()) %>%
group_by(patient_id, cohort_year, period_index) %>%
count(),
by = c("patient_id", "cohort_year", "period_index")
) %>%
mutate(n = replace_na(n, 0)) %>%
group_by(cohort_year, period_index, .data[[var]]) %>%
summarise(mean_n = mean(n),
mean_ci = boot_ci(n, statistic = meanfun, R = 1000),
n_patients = n()) %>%
ungroup() %>%
mutate(var_name = rep(c("ci_lower", "ci_upper"), times = n()/2)) %>%
pivot_wider(names_from = "var_name", values_from = "mean_ci")
outpatient_mean = outpatient_mean %>%
mutate(date = paste0(cohort_year, "-01-01") %>% as.Date() +
(period_index -1)*7 +3)
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = sex, fill = sex, group = cohort_year)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
var = NULL
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
bind_rows(
data_patient_2021 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
group_by(patient_id, cohort_year, .data[[var]]) %>%
summarise(period_index = 1:52) %>%
ungroup() %>%
left_join(
data_outpatient %>%
mutate(period_index = week(outpatient_date),
cohort_year = year(outpatient_date) %>% as.character()) %>%
group_by(patient_id, cohort_year, period_index) %>%
count(),
by = c("patient_id", "cohort_year", "period_index")
) %>%
mutate(n = replace_na(n, 0)) %>%
group_by(cohort_year, period_index, .data[[var]]) %>%
summarise(mean_n = mean(n),
mean_ci = boot_ci(n, statistic = meanfun, R = 1000),
n_patients = n()) %>%
ungroup() %>%
mutate(var_name = rep(c("ci_lower", "ci_upper"), times = n()/2)) %>%
pivot_wider(names_from = "var_name", values_from = "mean_ci")
outpatient_mean = outpatient_mean %>%
mutate(date = paste0(cohort_year, "-01-01") %>% as.Date() +
(period_index -1)*7 +3)
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = sex, fill = sex, group = cohort_year)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
# Load library
library("tidyverse")
library("lubridate")
library("finalfit")
library("boot")
# Functions ----
meanfun = function(data, i){
d = data[i]
return(mean(d))
}
boot_ci = function(x, statistic, R){
ci = boot(x, statistic, R) %>%
boot.ci(conf = 0.95, type = "perc")
output = c(ci$percent[4], ci$percent[5])
return(output)
}
# Read processed data  ----
data_patient_2019 = read_rds(here::here("output", "data", "data_patient_2019.rds"))
data_patient_2020 = read_rds(here::here("output", "data", "data_patient_2020.rds"))
data_patient_2021 = read_rds(here::here("output", "data", "data_patient_2021.rds"))
data_admissions   = read_rds(here::here("output", "data", "data_admissions.rds"))
data_outpatient   = read_rds(here::here("output", "data", "data_outpatient.rds"))
data_gp           = read_rds(here::here("output", "data", "data_gp.rds"))
# Create summary table stratified by cohort year ----
dependent = "cohort_year"
explanatory = c("covid_status", "age", "age_factor", "sex",
"ethnicity", "ethnicity_6_sus", "ethnicity_comb",
"region", "imd_Q5", "rural_urban",
"asthma", "diabetes",
"death_factor",
"admission_count_factor",
"gp_contact_count_factor")
tbl_summary_cohort_year = data_patient_2019 %>%
select(all_of(c(dependent, explanatory))) %>%
bind_rows(data_patient_2020 %>%
select(all_of(c(dependent, explanatory)))) %>%
bind_rows(data_patient_2021 %>%
select(all_of(c(dependent, explanatory)))) %>%
summary_factorlist(dependent, explanatory, p = TRUE,
add_col_totals = TRUE,
add_row_total = TRUE)
# Outpatient appointments ----
var = NULL
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
bind_rows(
data_patient_2021 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
group_by(patient_id, cohort_year, .data[[var]]) %>%
summarise(period_index = 1:52) %>%
ungroup() %>%
left_join(
data_outpatient %>%
mutate(period_index = week(outpatient_date),
cohort_year = year(outpatient_date) %>% as.character()) %>%
group_by(patient_id, cohort_year, period_index) %>%
count(),
by = c("patient_id", "cohort_year", "period_index")
) %>%
mutate(n = replace_na(n, 0)) %>%
group_by(cohort_year, period_index, .data[[var]]) %>%
summarise(mean_n = mean(n),
mean_ci = boot_ci(n, statistic = meanfun, R = 1000),
n_patients = n()) %>%
ungroup() %>%
mutate(var_name = rep(c("ci_lower", "ci_upper"), times = n()/2)) %>%
pivot_wider(names_from = "var_name", values_from = "mean_ci")
outpatient_mean = outpatient_mean %>%
mutate(date = paste0(cohort_year, "-01-01") %>% as.Date() +
(period_index -1)*7 +3)
outpatient_mean %>%
ggplot(aes_string("date", "mean_n", colour = "var", fill = "var")) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2)
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
bind_rows(
data_patient_2021 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
group_by_(patient_id, cohort_year, "var") %>%
summarise(period_index = 1:52) %>%
ungroup() %>%
left_join(
data_outpatient %>%
mutate(period_index = week(outpatient_date),
cohort_year = year(outpatient_date) %>% as.character()) %>%
group_by(patient_id, cohort_year, period_index) %>%
count(),
by = c("patient_id", "cohort_year", "period_index")
) %>%
mutate(n = replace_na(n, 0)) %>%
group_by(cohort_year, period_index, .data[[var]]) %>%
summarise(mean_n = mean(n),
mean_ci = boot_ci(n, statistic = meanfun, R = 1000),
n_patients = n()) %>%
ungroup() %>%
mutate(var_name = rep(c("ci_lower", "ci_upper"), times = n()/2)) %>%
pivot_wider(names_from = "var_name", values_from = "mean_ci")
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
bind_rows(
data_patient_2021 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
group_by_("patient_id", "cohort_year", "var") %>%
summarise(period_index = 1:52) %>%
ungroup() %>%
left_join(
data_outpatient %>%
mutate(period_index = week(outpatient_date),
cohort_year = year(outpatient_date) %>% as.character()) %>%
group_by(patient_id, cohort_year, period_index) %>%
count(),
by = c("patient_id", "cohort_year", "period_index")
) %>%
mutate(n = replace_na(n, 0)) %>%
group_by_("cohort_year", "period_index", "var") %>%
summarise(mean_n = mean(n),
mean_ci = boot_ci(n, statistic = meanfun, R = 1000),
n_patients = n()) %>%
ungroup() %>%
mutate(var_name = rep(c("ci_lower", "ci_upper"), times = n()/2)) %>%
pivot_wider(names_from = "var_name", values_from = "mean_ci")
# Load library
library("tidyverse")
library("lubridate")
library("finalfit")
library("boot")
# Functions ----
meanfun = function(data, i){
d = data[i]
return(mean(d))
}
boot_ci = function(x, statistic, R){
ci = boot(x, statistic, R) %>%
boot.ci(conf = 0.95, type = "perc")
output = c(ci$percent[4], ci$percent[5])
return(output)
}
# Read processed data  ----
data_patient_2019 = read_rds(here::here("output", "data", "data_patient_2019.rds"))
data_patient_2020 = read_rds(here::here("output", "data", "data_patient_2020.rds"))
data_patient_2021 = read_rds(here::here("output", "data", "data_patient_2021.rds"))
data_admissions   = read_rds(here::here("output", "data", "data_admissions.rds"))
data_outpatient   = read_rds(here::here("output", "data", "data_outpatient.rds"))
data_gp           = read_rds(here::here("output", "data", "data_gp.rds"))
# Create summary table stratified by cohort year ----
dependent = "cohort_year"
explanatory = c("covid_status", "age", "age_factor", "sex",
"ethnicity", "ethnicity_6_sus", "ethnicity_comb",
"region", "imd_Q5", "rural_urban",
"asthma", "diabetes",
"death_factor",
"admission_count_factor",
"gp_contact_count_factor")
tbl_summary_cohort_year = data_patient_2019 %>%
select(all_of(c(dependent, explanatory))) %>%
bind_rows(data_patient_2020 %>%
select(all_of(c(dependent, explanatory)))) %>%
bind_rows(data_patient_2021 %>%
select(all_of(c(dependent, explanatory)))) %>%
summary_factorlist(dependent, explanatory, p = TRUE,
add_col_totals = TRUE,
add_row_total = TRUE)
# Outpatient appointments ----
var = "sex"
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
bind_rows(
data_patient_2021 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
group_by(patient_id, cohort_year, .data[[var]]) %>%
summarise(period_index = 1:52) %>%
ungroup() %>%
left_join(
data_outpatient %>%
mutate(period_index = week(outpatient_date),
cohort_year = year(outpatient_date) %>% as.character()) %>%
group_by(patient_id, cohort_year, period_index) %>%
count(),
by = c("patient_id", "cohort_year", "period_index")
) %>%
mutate(n = replace_na(n, 0)) %>%
group_by(cohort_year, period_index, .data[[var]]) %>%
summarise(mean_n = mean(n),
mean_ci = boot_ci(n, statistic = meanfun, R = 1000),
n_patients = n()) %>%
ungroup() %>%
mutate(var_name = rep(c("ci_lower", "ci_upper"), times = n()/2)) %>%
pivot_wider(names_from = "var_name", values_from = "mean_ci")
outpatient_mean = outpatient_mean %>%
mutate(date = paste0(cohort_year, "-01-01") %>% as.Date() +
(period_index -1)*7 +3)
outpatient_mean %>%
ggplot(aes_string("date", "mean_n", colour = "var", fill = "var")) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
theme_bw()
outpatient_mean %>%
ggplot(aes("date", "mean_n", colour = var, fill = var)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
theme_bw()
outpatient_mean %>%
ggplot(aes("date", "mean_n", colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
theme_bw()
View(outpatient_mean)
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = sex, fill = sex)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
theme_bw()
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = var, fill = var)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
theme_bw()
outpatient_mean %>%
ggplot(aes(date, mean_n, colour = .data[[var]], fill = .data[[var]])) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
theme_bw()
View(outpatient_mean)
var = NULL
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
)
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
bind_rows(
data_patient_2021 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
group_by(patient_id, cohort_year, .data[[var]])
outpatient_mean = data_patient_2019 %>%
select(patient_id, cohort_year, all_of(var)) %>%
bind_rows(
data_patient_2020 %>%
select(patient_id, cohort_year, all_of(var))
) %>%
bind_rows(
data_patient_2021 %>%
select(patient_id, cohort_year, all_of(var))
)
outpatient_mean = outpatient_mean%>%
group_by(patient_id, cohort_year) %>%
summarise(period_index = 1:52) %>%
ungroup() %>%
left_join(
data_outpatient %>%
mutate(period_index = week(outpatient_date),
cohort_year = year(outpatient_date) %>% as.character()) %>%
group_by(patient_id, cohort_year, period_index) %>%
count(),
by = c("patient_id", "cohort_year", "period_index")
) %>%
mutate(n = replace_na(n, 0)) %>%
group_by(cohort_year, period_index) %>%
summarise(mean_n = mean(n),
mean_ci = boot_ci(n, statistic = meanfun, R = 1000),
n_patients = n()) %>%
ungroup() %>%
mutate(var_name = rep(c("ci_lower", "ci_upper"), times = n()/2)) %>%
pivot_wider(names_from = "var_name", values_from = "mean_ci")
outpatient_mean = outpatient_mean %>%
mutate(date = paste0(cohort_year, "-01-01") %>% as.Date() +
(period_index -1)*7 +3)
outpatient_mean %>%
ggplot(aes(date, mean_n)) +
geom_line() +
geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2) +
theme_bw()
