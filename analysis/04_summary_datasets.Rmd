---
title: "Dataset Summary"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

# Disclosure controls

* All tabulated counts are rounded to the nearest 10 (0 counts retained).


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, 
                      warning=FALSE)

# Load packages ----
library(tidyverse)
library(lubridate)
library(finalfit)
library(scales)
library(zoo)
library(knitr)

# Load custom functions and lookup tables ----
source(here::here("analysis", "00_utility_functions.R"))
source(here::here("analysis", "00_lookup_tables.R"))

# Plot theme
theme_set(theme_bw())

```


```{r load_data}
# Load datasets
data_patient = read_rds(here::here("output", "data", "data_patient.rds"))
data_testing = read_rds(here::here("output", "data", "data_testing.rds"))
data_admissions = read_rds(here::here("output", "data", "data_admissions.rds"))
data_outpatient = read_rds(here::here("output", "data", "data_outpatient.rds"))
data_gp = read_rds(here::here("output", "data", "data_gp.rds"))

```


# Patient demographics

```{r}

dependent = "covid_status_tp"
explanatory = c(
  "age_2019",
  "age_2019_factor",
  "sex",
  "ethnicity",
  "imd_Q5_2019",
  "region_2019",
  "rural_urban_2019",
  
  "covid_status_fup",
  "covid_test_neg_tp_count",
  "covid_test_pos_tp_count",
  "covid_test_neg_fup_count",
  "covid_test_pos_fup_count",
  
  
  "asthma",
  "chronic_respiratory_disease",
  "cancer",
  "chronic_cardiac_disease",
  "chronic_kidney_disease",
  "chronic_liver_disease",
  "diabetes",
  "severe_obesity",
  "permanent_immunodeficiency",
  "intellectual_learning_disability",
  "severe_mental_illness",
  "neurological_diseases",
  "pregnency_delivery"
)

data_patient %>% 
  summary_factorlist(
    dependent = dependent,
    explanatory = explanatory,
    total_col = TRUE,
    add_col_totals = TRUE,
    na_include = TRUE
  ) %>%
  ff_round_counts() %>% 
  kable(align = c("l", "r", "r", "r", "r", "r"))

```

# Covid-19 Testing

```{r}

data_testing %>% 
  mutate(
    date = test_date %>% cut(breaks = "week")
  ) %>% 
  count(date, result, .drop = FALSE) %>%
  group_by(result) %>% 
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA),
         date = date %>% as_date()) %>%
  ungroup() %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "6 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom") +
  facet_wrap(~ result)

```



# Hospital Admission Spells {.tabset}

Note: Same-day admission spells cannot be queried; the last hospital spell for patients who are readmitted on the same day will be missed. 

```{r combine_lookup}
# Combine with lookup table ----
## Admissions data ----
### Primary diagnosis ----
data_admissions = data_admissions %>%
  left_join(
    lookup_icd10 %>%
      mutate(
        code = code %>% ff_label("Primary diagnosis"),
        description_short = description_short %>% ff_label("Primary diagnosis"),
        chapter_short = chapter_short %>% ff_label("Primary diagnosis"),
      ) %>% 
      select(
        primary_diagnosis = code,
        primary_diagnosis.description = description_short,
        primary_diagnosis.chapter = chapter_short
      ),
    by = "primary_diagnosis"
  )

### Treatment function ----
data_admissions = data_admissions %>%
  left_join(
    lookup_treatment_function %>% 
      select(
        treatment_function = Code,
        treatment_function.description = Title,
        treatment_function.category = Category
      ),
    by = "treatment_function"
  )

### Admission method ----
data_admissions = data_admissions %>%
  left_join(
    lookup_admission_method %>% 
      select(
        admission_method = Code,
        admission_method.description = Description,
        admission_method.category = Category
      ),
    by = "admission_method"
  )


```

## Factor summary

```{r factor_summary}

dependent = NULL
explanatory = c("admission_method.category",
                "treatment_function.category",
                "primary_diagnosis.chapter")

data_admissions %>% 
  summary_factorlist(
    dependent = dependent,
    explanatory = explanatory,
    add_col_totals = TRUE,
    na_include = TRUE
  ) %>%
  ff_round_counts() %>% 
  kable(align = c("l", "l", "r", "r", "r"))

```



## Admission date {.tabset}

### All

```{r}

data_admissions %>% 
  mutate(
    date = admission_date %>% cut(breaks = "week")
  ) %>% 
  count(date, .drop = FALSE) %>%
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA),
         date = date %>% as_date()) %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "3 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom")

```

### Admission method

```{r}

data_admissions %>% 
  mutate(
    date = admission_date %>% cut(breaks = "week")
  ) %>%
  count(date, admission_method.category, .drop = FALSE) %>%
  group_by(admission_method.category) %>% 
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA)) %>% 
  ungroup() %>% 
  mutate(date = date %>% as_date()) %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "6 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom") +
  facet_wrap(~ admission_method.category)


```

### Specialty

```{r}

data_admissions %>% 
  mutate(
    date = admission_date %>% cut(breaks = "week")
  ) %>%
  count(date, treatment_function.category, .drop = FALSE) %>%
  group_by(treatment_function.category) %>% 
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA)) %>% 
  ungroup() %>% 
  mutate(date = date %>% as_date()) %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "6 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom") +
  facet_wrap(~ treatment_function.category)

```

### Primary Diagnosis

```{r fig.height=14, fig.width=10}

data_admissions %>% 
  mutate(
    date = admission_date %>% cut(breaks = "week")
  ) %>%
  count(date, primary_diagnosis.chapter, .drop = FALSE) %>%
  group_by(primary_diagnosis.chapter) %>% 
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA)) %>% 
  ungroup() %>% 
  mutate(date = date %>% as_date()) %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "6 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom") +
  facet_wrap(~ primary_diagnosis.chapter, ncol = 3)

```

## Specialty

```{r}

data_admissions %>%
  mutate(treatment_function.description = paste0(treatment_function, ": ", 
                                     treatment_function.description)) %>% 
  count(treatment_function.description) %>% 
  arrange(desc(n)) %>%
  mutate(n = paste0(n, " (", format(round(n/sum(n)*100, 1), nsmall = 1), ")")) %>% 
  filter() %>% 
  kable(align = c("l", "r"),
        col.names = c("Specialty", "n (%)"))

```

## Primary Diagnosis

```{r}

data_admissions %>%
  mutate(primary_diagnosis.description = paste0(primary_diagnosis, ": ",
                                                primary_diagnosis.description)) %>% 
  count(primary_diagnosis.description) %>% 
  arrange(desc(n)) %>%
  mutate(n = paste0(n, " (", format(round(n/sum(n)*100, 1), nsmall = 1), ")")) %>% 
  filter() %>% 
  kable(align = c("l", "r"),
        col.names = c("Primary diagnosis", "n (%)"))

```

## Length of stay

```{r}

data_admissions %>%  
  mutate(
    length_of_stay = (discharge_date - admission_date) %>% 
      as.numeric(),
    length_of_stay.factor = length_of_stay %>% 
      cut(breaks = c(-Inf, 0:6, 13, 29, Inf)) %>% 
      fct_recode(
        "0" = "(-Inf,0]",
        "1" = "(0,1]",
        "2" = "(1,2]",
        "3" = "(2,3]",
        "4" = "(3,4]",
        "5" = "(4,5]",
        "6" = "(5,6]",
        "7-13" = "(6,13]",
        "14-29" = "(13,29]",
        "30+"   = "(29, Inf]",
      )
  ) %>% 
  ggplot(aes(length_of_stay.factor)) +
  geom_bar() +
  labs(x = "Length of stay (days)")

```

# Outpatient Appointments

Note: Sequential same-day appointments cannot be queried. Hence this data represents outpatient contact-days rather than number of outpatient appointments. It is estimated that 16.5% of outpatient contact-days consist of 2 or more outpatient appointments (details [here](https://github.com/opensafely-core/cohort-extractor/issues/492#issuecomment-872295921)).

```{r}

data_outpatient %>% 
  mutate(
    date = outpatient_date %>% cut(breaks = "week")
  ) %>% 
  count(date, .drop = FALSE) %>%
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA),
         date = date %>% as_date()) %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "3 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom")

```

# GP Records {.tabset}

Definition: Dates corresponding to SNoMed codes within the following [hierarchy](https://itservices.midlandsandlancashirecsu.nhs.uk/media/1447/snomed-ct-glossary-hierarchy-and-semantic-tags_v1.pdf) (semantic tags):

* Clinical finding (disorder, finding)
* Procedure (procedure, regime/therapy)
* Observable Entity (observable entity)
* Specimen (specimen)

Dates coinciding with secondary care (hospital spells and outpatient appointments) will be filtered out to avoid double counting.

## All dates

```{r}

data_gp %>% 
  mutate(
    date = gp_date %>% cut(breaks = "week")
  ) %>% 
  count(date, .drop = FALSE) %>%
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA),
         date = date %>% as_date()) %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "3 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom")

```

## Secondary care double counting {.tabset}

### All patients

```{r}

data_gp = data_gp %>% 
  mutate(
    secondary_care_flag = if_else(
      outpatient_flag == 1 | admission_flag == 1,
      "Dates coinciding with secondary care",
      "Dates unique to primary care"
    ) %>%
      factor()
  )

data_gp %>% 
  mutate(
    date = gp_date %>% cut(breaks = "week")
  ) %>%
  count(date, secondary_care_flag, .drop = FALSE) %>%
  group_by(secondary_care_flag) %>% 
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA)) %>% 
  ungroup() %>% 
  mutate(date = date %>% as_date()) %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "6 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom") +
  facet_wrap(~ secondary_care_flag)


```

### Patients in secondary care data

```{r}

data_gp %>%
  filter(patient_id %in% data_admissions$patient_id |
           patient_id %in% data_outpatient$patient_id) %>% 
  mutate(
    date = gp_date %>% cut(breaks = "week")
  ) %>%
  count(date, secondary_care_flag, .drop = FALSE) %>%
  group_by(secondary_care_flag) %>% 
  mutate(roll_mean = rollmean(n, 4, align = "right", fill = NA)) %>% 
  ungroup() %>% 
  mutate(date = date %>% as_date()) %>% 
  ggplot(aes(date, n)) +
  geom_col() +
  geom_line(aes(date, roll_mean, linetype = "4-week averge"), colour = "red") +
  scale_x_date(labels = date_format("%b\n%Y"),
               breaks = seq(from = ymd("2015-01-01"), to = ymd("2022-12-01"), by = "6 month")) +
  labs(y = "Weekly count", x = NULL, linetype = NULL) +
  theme(legend.position = "bottom") +
  facet_wrap(~ secondary_care_flag)

```

